/**
 * @author dav i d.dai                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
 */
import React from 'react'
import isEqual from 'lodash/isEqual'
import isArray from 'lodash/isArray'
import isObject from 'lodash/isObject'
import qs from 'qs'
import SelectPicker from '../select-picker/index'

export default class HrComboBox extends React.Component {
    static defaultProps = {
        prefixCls: 'hr-combo-box',
    }

    // 构造函数
    constructor(props) {
        super(props)
        this.state = {
            option: {},
            value: '',
            code: props.code,
            dataset: [],
        }
    }

    // 页面渲染完成
    componentDidMount() {
        this.getParam()
    }

    static getDerivedStateFromProps(nextProps, prevState) {
        const newState = {}
        if (nextProps.code !== prevState.code) {
            newState.code = nextProps.code
        }
        return newState
    }

    componentDidUpdate(prevProps) {
        if (prevProps.code !== this.props.code) {
            this.getParam()
        } else if (!isEqual(prevProps.queryData, this.props.queryData)) {
            this.getDataSet()
        }
    }

    /**
     * 获取参数
     */
    getParam() {
        const { code } = this.state
        this.$axios
            .get(`/platform/selector/info/getSelectorInfoByCode?code=${code}`)
            .then((res) => {
                // edit by john.gao 特殊处理缴费单位接口不去掉.search
                if (res.serviceUrl && res.serviceUrl.indexOf('getPayUnitForSelector') === -1) {
                    res.serviceUrl = res.serviceUrl.replace('.search', '')
                }
                this.setState(
                    {
                        option: res,
                    },
                    () => {
                        this.getDataSet()
                    }
                )
            })
    }

    // 处理默认值
    getValue(value) {
        const { option } = this.state
        if (option) {
            if (isArray(value)) {
                value = value.map((item) =>
                    isObject(item) ? item[option.valueField] || '' : item
                )
            } else if (isObject(value)) {
                value = `${value[option.valueField]}` || ''
            } else {
                value = value || (value === 0 ? `${this.value}` : '')
            }
        }
        return value
    }

    // 获取值集
    getDataSet() {
        const { option } = this.state
        const { queryData, datasetChange } = this.props
        if (option.serviceUrl) {
            const param = qs.parse(option.param) || {}
            this.$axios
                .post(option.serviceUrl, { ...queryData, ...param })
                .then((res) => {
                    res = res || []
                    this.fullData = res
                    datasetChange && datasetChange(res)
                    this.setState({
                        dataset: [
                            res.map((item) => ({
                                value: item[option.valueField],
                                label: item[option.displayField],
                            })),
                        ],
                    })
                })
        } else {
            this.setState({
                dataset: [],
            })
            datasetChange && datasetChange([])
        }
    }
    
    /**
     * 设置值集
     * @param {Array} list 列表
     */
    setDataSet(list) {
      this.setState({
        dataset: [list]
      })
    }

    handleChange(val, values) {
        const { onChange } = this.props
        if (isArray(values)) {
            val = values.map((o) => o.value)
        } else if (isObject(values)) {
            val = values.value
        }
        onChange && onChange(val, this.fullData)
    }

    // 页面渲染
    render() {
        const { dataset } = this.state
        const {
            prefixCls,
            value,
            title,
            ismust,
            readOnly,
            placeholder,
        } = this.props
        return (
            <SelectPicker
                value={this.getValue(value)}
                className={prefixCls}
                title={title}
                ismust={ismust}
                data={dataset}
                readOnly={readOnly}
                placeholder={placeholder}
                onOk={(val, values) => this.handleChange(val, values)}
            />
        )
    }
}
